name: Check and Update Inkscape

on:
  schedule:
    # Run every 2 days at 00:00 UTC
    - cron: '0 0 */2 * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if version unchanged'
        required: false
        default: false
        type: boolean
      increment_pkgrel:
        description: 'Increment pkgrel (for same version updates)'
        required: false
        default: false
        type: boolean

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check for latest Inkscape stable version and AppImage URL
      id: check
      run: |
        RELEASE_PAGE=$(curl -sL "https://inkscape.org/release/")
        LATEST_VERSION=$(echo "$RELEASE_PAGE" | grep -oP 'inkscape-\K[0-9]+\.[0-9]+(\.[0-9]+)?' | head -1)
        
        if [[ -z "$LATEST_VERSION" ]]; then
          echo "Error: Could not determine latest version"
          exit 1
        fi
        
        echo "Latest version: $LATEST_VERSION"
        echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
        
        APPIMAGE_PAGE=$(curl -sL "https://inkscape.org/release/inkscape-${LATEST_VERSION}/gnulinux/appimage/dl/")
        
        APPIMAGE_URL=$(echo "$APPIMAGE_PAGE" | grep -oP 'https://inkscape\.org/gallery/item/[0-9]+/[^"]+\.AppImage' | head -1)
        
        # If not found, try alternative pattern
        if [[ -z "$APPIMAGE_URL" ]]; then
          APPIMAGE_URL=$(echo "$APPIMAGE_PAGE" | grep -oP 'href="(/gallery/item/[0-9]+/[^"]+\.AppImage)"' | head -1 | sed 's/href="/https:\/\/inkscape.org/' | sed 's/"$//')
        fi
        
        # Another fallback: look for redirect or meta refresh
        if [[ -z "$APPIMAGE_URL" ]]; then
          # The dl/ page might redirect, follow it
          REDIRECT_URL=$(curl -sI "https://inkscape.org/release/inkscape-${LATEST_VERSION}/gnulinux/appimage/dl/" | grep -i "location:" | tail -1 | awk '{print $2}' | tr -d '\r')
          if [[ -n "$REDIRECT_URL" && "$REDIRECT_URL" == *".AppImage"* ]]; then
            APPIMAGE_URL="$REDIRECT_URL"
          fi
        fi
        
        # Final fallback: search the gallery directly
        if [[ -z "$APPIMAGE_URL" ]]; then
          echo "Searching gallery for AppImage..."
          GALLERY_SEARCH=$(curl -sL "https://inkscape.org/gallery/?q=AppImage+${LATEST_VERSION}")
          APPIMAGE_URL=$(echo "$GALLERY_SEARCH" | grep -oP 'https://inkscape\.org/gallery/item/[0-9]+/Inkscape[^"]*x86_64\.AppImage' | head -1)
        fi
        
        if [[ -z "$APPIMAGE_URL" ]]; then
          echo "Error: Could not find AppImage download URL"
          exit 1
        fi
        
        echo "AppImage URL: $APPIMAGE_URL"
        echo "appimage_url=$APPIMAGE_URL" >> $GITHUB_OUTPUT
        
        # Get current version from AUR PKGBUILD
        CURRENT_VERSION=$(curl -s "https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=inkscape-bin" | grep "^pkgver=" | cut -d= -f2 || echo "none")
        echo "Current version in AUR: $CURRENT_VERSION"
        echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        
        if [[ "$LATEST_VERSION" != "$CURRENT_VERSION" ]] || [[ "${{ inputs.force_update }}" == "true" ]]; then
          echo "update_needed=true" >> $GITHUB_OUTPUT
        else
          echo "update_needed=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Download and verify AppImage
      if: steps.check.outputs.update_needed == 'true'
      id: download
      run: |
        URL="${{ steps.check.outputs.appimage_url }}"
        
        echo "Downloading from: $URL"
        
        # Download with proper redirect following
        wget --max-redirect=10 -O inkscape.AppImage "$URL"
        
        # Verify it's actually an AppImage (check magic bytes)
        FILE_TYPE=$(file inkscape.AppImage)
        echo "File type: $FILE_TYPE"
        
        if [[ ! "$FILE_TYPE" == *"ELF"* && ! "$FILE_TYPE" == *"executable"* && ! "$FILE_TYPE" == *"AppImage"* ]]; then
          echo "Error: Downloaded file is not a valid AppImage"
          echo "File content preview:"
          head -c 500 inkscape.AppImage
          exit 1
        fi
        
        # Verify file size (AppImage should be > 50MB)
        SIZE=$(stat -c%s inkscape.AppImage)
        echo "Download size: $SIZE bytes"
        
        if [[ $SIZE -lt 50000000 ]]; then
          echo "Error: Downloaded file too small (expected ~100MB+)"
          exit 1
        fi
        
        # Calculate checksum
        CHECKSUM=$(sha256sum inkscape.AppImage | cut -d ' ' -f 1)
        echo "sha256sum=$CHECKSUM" >> $GITHUB_OUTPUT
        
        rm inkscape.AppImage
    
    - name: Get current pkgrel from AUR
      if: steps.check.outputs.update_needed == 'true'
      id: current_pkgrel
      run: |
        CURRENT_PKGREL=$(curl -s "https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=inkscape-bin" | grep "^pkgrel=" | cut -d= -f2 || echo "0")
        echo "current_pkgrel=$CURRENT_PKGREL" >> $GITHUB_OUTPUT
        
        AUR_VERSION=$(curl -s "https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=inkscape-bin" | grep "^pkgver=" | cut -d= -f2 || echo "none")
        if [[ "$AUR_VERSION" == "${{ steps.check.outputs.latest_version }}" ]]; then
          echo "same_version=true" >> $GITHUB_OUTPUT
        else
          echo "same_version=false" >> $GITHUB_OUTPUT
        fi
      continue-on-error: true
    
    - name: Determine pkgrel
      if: steps.check.outputs.update_needed == 'true'
      id: pkgrel
      run: |
        if [[ "${{ steps.current_pkgrel.outputs.same_version }}" == "true" ]] && [[ "${{ inputs.increment_pkgrel }}" == "true" ]]; then
          CURRENT=${{ steps.current_pkgrel.outputs.current_pkgrel }}
          NEW_PKGREL=$((CURRENT + 1))
          echo "pkgrel=$NEW_PKGREL" >> $GITHUB_OUTPUT
        else
          echo "pkgrel=1" >> $GITHUB_OUTPUT
        fi
    
    - name: Create PKGBUILD
      if: steps.check.outputs.update_needed == 'true'
      run: |
        mkdir -p aur-package
        cat > aur-package/PKGBUILD << 'EOF'
        # Maintainer: MLM-stuff gfxoxinzh@mozmail.com
        pkgname=inkscape-bin
        pkgver=${{ steps.check.outputs.latest_version }}
        pkgrel=${{ steps.pkgrel.outputs.pkgrel }}
        pkgdesc="Professional vector graphics editor - Prebuilt AppImage"
        arch=('x86_64')
        url="https://inkscape.org"
        license=('GPL-2.0-or-later')
        depends=('fuse2' 'hicolor-icon-theme')
        optdepends=('python: for extensions'
                    'python-numpy: for some extensions'
                    'python-lxml: for some extensions'
                    'fig2dev: xfig import'
                    'gvfs: file system support'
                    'pstoedit: PostScript support')
        provides=('inkscape')
        conflicts=('inkscape')
        options=('!strip')
        source=("inkscape-${pkgver}.AppImage::${{ steps.check.outputs.appimage_url }}"
                "inkscape.desktop")
        sha256sums=('${{ steps.download.outputs.sha256sum }}'
                    'SKIP')
        noextract=("inkscape-${pkgver}.AppImage")
        
        prepare() {
            chmod +x "inkscape-${pkgver}.AppImage"
            ./inkscape-${pkgver}.AppImage --appimage-extract >/dev/null 2>&1 || true
        }
        
        package() {
            install -Dm755 "inkscape-${pkgver}.AppImage" "$pkgdir/opt/inkscape/inkscape.AppImage"
            
            install -dm755 "$pkgdir/usr/bin"
            cat > "$pkgdir/usr/bin/inkscape" << 'WRAPPER'
        #!/bin/bash
        exec /opt/inkscape/inkscape.AppImage "$@"
        WRAPPER
            chmod 755 "$pkgdir/usr/bin/inkscape"
            
            install -Dm644 "$srcdir/inkscape.desktop" "$pkgdir/usr/share/applications/org.inkscape.Inkscape.desktop"
            
            if [[ -d "$srcdir/squashfs-root/usr/share/icons" ]]; then
                install -dm755 "$pkgdir/usr/share/icons/hicolor"
                cp -r "$srcdir/squashfs-root/usr/share/icons/hicolor"/* "$pkgdir/usr/share/icons/hicolor/"
            fi
            
            if [[ -f "$srcdir/squashfs-root/org.inkscape.Inkscape.svg" ]]; then
                install -Dm644 "$srcdir/squashfs-root/org.inkscape.Inkscape.svg" \
                    "$pkgdir/usr/share/icons/hicolor/scalable/apps/org.inkscape.Inkscape.svg"
            fi
        }
        EOF
        
        cat > aur-package/inkscape.desktop << 'EOF'
        [Desktop Entry]
        Name=Inkscape
        Comment=Create and edit Scalable Vector Graphics images
        GenericName=Vector Graphics Editor
        Exec=inkscape %F
        Icon=org.inkscape.Inkscape
        Terminal=false
        Type=Application
        Categories=Graphics;VectorGraphics;GTK;
        MimeType=image/svg+xml;image/svg+xml-compressed;application/vnd.corel-draw;application/pdf;application/postscript;image/x-eps;application/illustrator;image/x-wmf;image/x-emf;
        StartupNotify=true
        StartupWMClass=inkscape
        Keywords=vector;graphics;svg;drawing;illustration;
        EOF
    
    - name: Publish to AUR
      if: steps.check.outputs.update_needed == 'true'
      uses: mlm-games/aur-deploy-action@master
      with:
        pkgname: inkscape-bin
        pkgbuild: aur-package/PKGBUILD
        assets: |
          aur-package/inkscape.desktop
        commit_username: MLM-stuff
        commit_email: gfxoxinzh@mozmail.com
        ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
        commit_message: "Update to version ${{ steps.check.outputs.latest_version }}-${{ steps.pkgrel.outputs.pkgrel }}"
